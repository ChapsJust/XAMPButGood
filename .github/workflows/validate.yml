# =============================================================================
# GitHub Actions - Validate Docker Compose Configuration
# =============================================================================
# Runs on every push and pull request to ensure docker-compose.yml is valid
# and all services can start successfully.
# =============================================================================

name: Validate Docker Compose

on:
  push:
    branches: [main, master]
    paths:
      - "docker-compose.yml"
      - ".env.example"
      - ".github/workflows/validate.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "docker-compose.yml"
      - ".env.example"
      - ".github/workflows/validate.yml"

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env from example
        run: cp .env.example .env

      - name: Load environment variables
        run: |
          set -a
          source .env
          set +a
          echo "POSTGRES_USER=$POSTGRES_USER" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> $GITHUB_ENV
          echo "POSTGRES_DB=$POSTGRES_DB" >> $GITHUB_ENV
          echo "MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD" >> $GITHUB_ENV
          echo "MYSQL_USER=$MYSQL_USER" >> $GITHUB_ENV
          echo "MYSQL_PASSWORD=$MYSQL_PASSWORD" >> $GITHUB_ENV
          echo "MYSQL_DATABASE=$MYSQL_DATABASE" >> $GITHUB_ENV
          echo "MONGO_ROOT_USERNAME=$MONGO_ROOT_USERNAME" >> $GITHUB_ENV
          echo "MONGO_ROOT_PASSWORD=$MONGO_ROOT_PASSWORD" >> $GITHUB_ENV
          echo "REDIS_PASSWORD=$REDIS_PASSWORD" >> $GITHUB_ENV

      - name: Validate docker-compose syntax
        run: docker compose config --quiet

      - name: Start core services
        run: docker compose up -d postgres mysql mongodb redis

      - name: Wait for services to be healthy
        run: |
          echo "⏳ Waiting for services to become healthy..."

          for i in {1..24}; do
            echo "Check $i/24..."
            
            all_healthy=true
            for service in postgres mysql mongodb redis; do
              status=$(docker compose ps $service --format "{{.Health}}" 2>/dev/null || echo "unknown")
              if [ "$status" != "healthy" ]; then
                all_healthy=false
                echo "  $service: $status"
              else
                echo "  $service: ✅ healthy"
              fi
            done
            
            if [ "$all_healthy" = true ]; then
              echo "✅ All services healthy!"
              break
            fi
            
            if [ $i -eq 24 ]; then
              echo "❌ Timeout waiting for services"
              docker compose ps
              docker compose logs
              exit 1
            fi
            
            sleep 5
          done

      - name: Test PostgreSQL connection
        run: |
          docker exec dev-postgres pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
          echo "✅ PostgreSQL connection OK"

      - name: Test MySQL connection
        run: |
          # Use mysql command to run a simple query (more reliable than mysqladmin)
          docker exec dev-mysql mysql \
            -h 127.0.0.1 \
            -u "$MYSQL_USER" \
            -p"$MYSQL_PASSWORD" \
            -e "SELECT 1;" \
            "$MYSQL_DATABASE" > /dev/null 2>&1
          echo "✅ MySQL connection OK"

      - name: Test MongoDB connection
        run: |
          docker exec dev-mongodb mongosh --quiet \
            "mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@127.0.0.1:27017/?authSource=admin" \
            --eval "db.runCommand('ping').ok"
          echo "✅ MongoDB connection OK"

      - name: Test Redis connection
        run: |
          result=$(docker exec dev-redis redis-cli -a "$REDIS_PASSWORD" --no-auth-warning ping)
          if [ "$result" = "PONG" ]; then
            echo "✅ Redis connection OK"
          else
            echo "❌ Redis connection failed"
            exit 1
          fi

      - name: Show running containers
        if: always()
        run: docker compose ps

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v
