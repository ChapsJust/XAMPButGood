# =============================================================================
# Docker Compose - XAMPP-like Local Dev Environment (FULLY OPTIMIZED)
# =============================================================================
# Stack: PostgreSQL, MySQL, MongoDB, Redis + Admin Interfaces
#
# Usage:
#   docker compose up -d                    → Start databases only
#   docker compose --profile admin up -d    → Start with web UIs
#   docker compose --profile full up -d     → Start everything
#
# Memory usage (all services): ~700MB - 900MB max
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL - Memory Optimized
  # ---------------------------------------------------------------------------
  # Tuning: shared_buffers=64MB, work_mem=4MB, effective_cache_size=128MB
  # shm_size prevents "could not resize shared memory segment" errors
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:18.1-alpine
    container_name: dev-postgres
    restart: unless-stopped
    shm_size: 128mb
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=64MB"
      - "-c"
      - "effective_cache_size=128MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "checkpoint_completion_target=0.9"
    networks:
      - dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # MySQL - Memory Optimized
  # ---------------------------------------------------------------------------
  # Tuning: innodb_buffer_pool=64MB, performance_schema=OFF saves ~200MB
  # Skip name resolution for faster connections
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:9.3
    container_name: dev-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command:
      - "--innodb-buffer-pool-size=64M"
      - "--innodb-redo-log-capacity=32M"
      - "--innodb-flush-log-at-trx-commit=2"
      - "--max-connections=30"
      - "--key-buffer-size=8M"
      - "--table-open-cache=200"
      - "--sort-buffer-size=256K"
      - "--read-buffer-size=128K"
      - "--thread-cache-size=4"
      - "--performance-schema=OFF"
      - "--skip-name-resolve"
    networks:
      - dev-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # MongoDB - Memory Optimized
  # ---------------------------------------------------------------------------
  # Tuning: WiredTiger cache=128MB (critical for Docker containers!)
  # Without this, MongoDB uses 50% of HOST RAM, ignoring container limits
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:8.2
    container_name: dev-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    command:
      - "--wiredTigerCacheSizeGB=0.25"
      - "--quiet"
      - "--setParameter"
      - "diagnosticDataCollectionEnabled=false"
    networks:
      - dev-network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok", "-u", "${MONGO_ROOT_USERNAME}", "-p", "${MONGO_ROOT_PASSWORD}", "--authenticationDatabase", "admin"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 350M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Redis - Memory Optimized (already lightweight)
  # ---------------------------------------------------------------------------
  # Tuning: maxmemory=64mb with LRU eviction
  # tcp-keepalive prevents zombie connections
  # ---------------------------------------------------------------------------
  redis:
    image: redis:8.4-alpine
    container_name: dev-redis
    restart: unless-stopped
    command:
      - "redis-server"
      - "--requirepass"
      - "${REDIS_PASSWORD}"
      - "--appendonly"
      - "yes"
      - "--maxmemory"
      - "64mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--tcp-keepalive"
      - "60"
      - "--save"
      - "900"
      - "1"
      - "--save"
      - "300"
      - "10"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - dev-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Adminer - Web UI for PostgreSQL & MySQL (profile: admin)
  # ---------------------------------------------------------------------------
  adminer:
    image: adminer:4-standalone
    container_name: dev-adminer
    restart: unless-stopped
    profiles:
      - admin
      - full
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    networks:
      - dev-network
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: dracula
    deploy:
      resources:
        limits:
          memory: 64M
    depends_on:
      postgres:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ---------------------------------------------------------------------------
  # Mongo Express - Web UI for MongoDB (profile: admin)
  # ---------------------------------------------------------------------------
  mongo-express:
    image: mongo-express:1.0
    container_name: dev-mongo-express
    restart: unless-stopped
    profiles:
      - admin
      - full
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    networks:
      - dev-network
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@mongodb:27017/
      ME_CONFIG_BASICAUTH: "false"
    deploy:
      resources:
        limits:
          memory: 64M
    depends_on:
      mongodb:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ---------------------------------------------------------------------------
  # Redis Commander - Web UI for Redis (profile: admin)
  # ---------------------------------------------------------------------------
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: dev-redis-commander
    restart: unless-stopped
    profiles:
      - admin
      - full
    ports:
      - "${REDIS_COMMANDER_PORT:-8082}:8081"
    networks:
      - dev-network
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD}
    deploy:
      resources:
        limits:
          memory: 64M
    depends_on:
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ---------------------------------------------------------------------------
  # MailHog - Email Testing SMTP Server (profile: full)
  # ---------------------------------------------------------------------------
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: dev-mailhog
    restart: unless-stopped
    profiles:
      - full
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_WEB_PORT:-8025}:8025"
    networks:
      - dev-network
    deploy:
      resources:
        limits:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# =============================================================================
# Networks
# =============================================================================
networks:
  dev-network:
    name: dev-network
    driver: bridge

# =============================================================================
# Volumes (Persistent Data)
# =============================================================================
volumes:
  postgres_data:
    name: dev-postgres-data
  mysql_data:
    name: dev-mysql-data
  mongodb_data:
    name: dev-mongodb-data
  mongodb_config:
    name: dev-mongodb-config
  redis_data:
    name: dev-redis-data
