# =============================================================================
# XAMPP-Docker Makefile
# =============================================================================
# Shortcuts for common Docker Compose commands
#
# Usage: make <target>
#   make up        → Start databases only
#   make admin     → Start with web interfaces
#   make down      → Stop and remove containers
#   make logs      → View all logs
#   make help      → Show all available commands
# =============================================================================

.PHONY: help up admin full down stop logs clean reset ps shell-postgres shell-mysql shell-mongo shell-redis

# Default target
.DEFAULT_GOAL := help

# -----------------------------------------------------------------------------
# Help
# -----------------------------------------------------------------------------
help: ## Show this help message
	@echo ""
	@echo "XAMPP-Docker - Available Commands"
	@echo "=================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""

# -----------------------------------------------------------------------------
# Service Management
# -----------------------------------------------------------------------------
up: ## Start databases only (PostgreSQL, MySQL, MongoDB, Redis)
	docker compose up -d

admin: ## Start databases + admin web interfaces
	docker compose --profile admin up -d

full: ## Start everything (databases + admin + MailHog)
	docker compose --profile full up -d

down: ## Stop and remove containers
	docker compose down

stop: ## Stop containers without removing them
	docker compose stop

restart: ## Restart all running services
	docker compose restart

ps: ## Show running containers and their status
	docker compose ps

# -----------------------------------------------------------------------------
# Logs
# -----------------------------------------------------------------------------
logs: ## View logs from all services (follow mode)
	docker compose logs -f

logs-postgres: ## View PostgreSQL logs
	docker compose logs -f postgres

logs-mysql: ## View MySQL logs
	docker compose logs -f mysql

logs-mongo: ## View MongoDB logs
	docker compose logs -f mongodb

logs-redis: ## View Redis logs
	docker compose logs -f redis

# -----------------------------------------------------------------------------
# Database CLI Access
# -----------------------------------------------------------------------------
shell-postgres: ## Open PostgreSQL CLI (psql)
	docker exec -it dev-postgres psql -U $${POSTGRES_USER:-devuser} -d $${POSTGRES_DB:-devdb}

shell-mysql: ## Open MySQL CLI
	docker exec -it dev-mysql mysql -u $${MYSQL_USER:-devuser} -p$${MYSQL_PASSWORD:-devpass123} $${MYSQL_DATABASE:-devdb}

shell-mongo: ## Open MongoDB CLI (mongosh)
	docker exec -it dev-mongodb mongosh -u $${MONGO_ROOT_USERNAME:-admin} -p $${MONGO_ROOT_PASSWORD:-mongopass123} --authenticationDatabase admin

shell-redis: ## Open Redis CLI
	docker exec -it dev-redis redis-cli -a $${REDIS_PASSWORD:-redispass123}

# -----------------------------------------------------------------------------
# Cleanup
# -----------------------------------------------------------------------------
clean: ## Stop and remove containers + volumes (keeps images)
	docker compose --profile full down -v

reset: ## Full reset: remove containers, volumes, and images
	docker compose --profile full down -v --rmi all

prune: ## Remove unused Docker resources (system-wide)
	docker system prune -f

validate: ## Validate docker-compose.yml syntax
	docker compose config --quiet && echo "docker-compose.yml is valid"

health: ## Check health status of all services
	@docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Health}}"